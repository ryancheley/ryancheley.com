<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>My Place on the Internet - pandas</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">My Place on the Internet</a></h1>
                <nav><ul>
                    <li><a href="/category/apple.html">Apple</a></li>
                    <li><a href="/category/automation.html">Automation</a></li>
                    <li><a href="/category/books.html">Books</a></li>
                    <li><a href="/category/coding.html">Coding</a></li>
                    <li><a href="/category/conferences.html">Conferences</a></li>
                    <li><a href="/category/conferenes.html">Conferenes</a></li>
                    <li><a href="/category/django.html">Django</a></li>
                    <li><a href="/category/github.html">GitHub</a></li>
                    <li><a href="/category/ios.html">iOS</a></li>
                    <li><a href="/category/macos.html">macOS</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li><a href="/category/music.html">Music</a></li>
                    <li><a href="/category/musings.html">Musings</a></li>
                    <li><a href="/category/podcasts.html">Podcasts</a></li>
                    <li><a href="/category/productivity.html">Productivity</a></li>
                    <li><a href="/category/professional-development.html">Professional Development</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                    <li><a href="/category/raspberry-pi.html">Raspberry Pi</a></li>
                    <li><a href="/category/server.html">Server</a></li>
                    <li><a href="/category/sports.html">Sports</a></li>
                    <li><a href="/category/web.html">Web</a></li>
                    <li><a href="/category/writing.html">Writing</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/using-python-to-check-for-file-changes-in-excel.html">Using Python to Check for File Changes in Excel</a></h1>
<footer class="post-info">
        <abbr class="published" title="2020-03-28T13:49:00+01:00">
                Published: Sat 28 March 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/ryan.html">ryan</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>
<p>tags: <a href="/tag/excel.html">excel</a> <a href="/tag/os.html">os</a> <a href="/tag/pandas.html">pandas</a> <a href="/tag/python.html">python</a> </p>
</footer><!-- /.post-info --><h2>The Problem</h2>
<p>Data exchange in healthcare is ... harder than it needs to be. Not all partners in the healthcare arena understand and use technology to its fullest benefit.</p>
<p>Take for example several health plans which want data reported to them for CMS (Centers for Medicare and Medicaid Services) regulations. They will ask their 'delegated' groups to fill out an excel file. As in, they expect you will <em>actually</em> fill out an excel file, either by manually entering the data OR by potentially copying and pasting your data into their excel file.</p>
<p>They will also, quite frequently, change their mind on what they want AND the order in which they want the data to appear in their excel file. But there's no change log to tell you what (if anything has changed). All that you will get is an email which states, "Here's the new template to be used for report XYZ" ... even if this 'new' report is the same as the last one that was sent.</p>
<p>Some solutions might be to use versioning software (like Git) but all they will do is tell you that there is a difference, not <em>what</em> the difference is. For example, when looking at a simple excel file added to git and using <code>git diff</code> you see:</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/Book3.xlsx b/Book3.xlsx</span>
<span class="gh">index 05a8b41..e96cdb5 100644</span>
Binary files a/Book3.xlsx and b/Book3.xlsx differ
</code></pre></div>

<p>This has been a giant pain in the butt for a while, but with the recent shelter-in-place directives, I have a bit more time on the weekends to solve these kinds of problems.</p>
<h2>The Solution</h2>
<p>Why Python of Course!</p>
<p>Only two libraries are needed to make the comparison: (1) os, (2) pandas</p>
<p>The basic idea is to:</p>
<ol>
<li>Load the files</li>
<li>use pandas to compare the files</li>
<li>write out the differences, if they exist  </li>
</ol>
<h3>Load the Files</h3>
<p>The code below loads the necessary libraries, and then loads the excel files into 2 pandas dataframes. One thing that my team has to watch out for are tab names that have leading spaces that aren't easy to see inside of excel. This can cause all sorts of nightmares from a troubleshooting perspective.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">file_original</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>\\<span class="n">path</span>\\<span class="n">to</span>\\<span class="n">original</span>\\<span class="n">file</span><span class="p">,</span> <span class="n">original_file</span><span class="o">.</span><span class="n">xlsx</span><span class="p">)</span>
<span class="n">file_new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>\\<span class="n">path</span>\\<span class="n">to</span>\\<span class="n">new</span>\\<span class="n">file</span><span class="p">,</span> <span class="n">new_file</span><span class="o">.</span><span class="n">xlsx</span><span class="p">)</span>

<span class="n">sheet_name_original</span> <span class="o">=</span> <span class="n">name_of_sheet_in_original_file</span>
<span class="n">sheet_name_new</span> <span class="o">=</span> <span class="n">name_of_sheet_in_new_file</span>

<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_original</span><span class="p">,</span> <span class="n">sheet_name_original</span><span class="p">)</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_new</span><span class="p">,</span> <span class="n">sheet_name_new</span><span class="p">)</span>
</code></pre></div>

<h3>Use Pandas to compare</h3>
<p>This is just a one liner, but is super powerful. Pandas DataFrames have a method to see if two frames are the same. So easy!</p>
<div class="highlight"><pre><span></span><code>data_frame_same = df1.equals(df2)
</code></pre></div>

<h3>Write out the differences if they exist:</h3>
<p>First we specify where we're going to write out the differences to. We use <code>w+</code> because we'll be writing out to a file AND potentially appending, depending on differences that are found. The <code>f.truncate(0)</code> will clear out the file so that we get just the differences on this run. If we don't do this then we'll just append to the file over and over again ... and that can get confusing.</p>
<div class="highlight"><pre><span></span><code>f.open(\\path\\to\\file\\to\\write\\differences.txt, &#39;w+&#39;)
f.truncate(0)
</code></pre></div>

<p>Next, we check to see if there are any differences and if they are, we write a simple message to our text file from above:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="nv">data_frame_same</span>:
    <span class="nv">f</span>.<span class="nv">write</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">No differences detected</span><span class="s1">&#39;</span><span class="ss">)</span>
</code></pre></div>

<p>If differences are found, then we loop through the lines of the file, finding the differences and and writing them to our file:</p>
<div class="highlight"><pre><span></span><code><span class="k">else</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="s1">&#39;*** WARNING *** Differences Found\n\n&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">df1</span><span class="p">.</span><span class="n">columns</span><span class="p">),</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">df2</span><span class="p">.</span><span class="n">columns</span><span class="p">)))</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">header1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df1</span><span class="p">.</span><span class="n">columns</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">header2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df2</span><span class="p">.</span><span class="n">columns</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">header1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nl">header2</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">f</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Headers are the same: {header1}\n&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="err">:</span><span class="w"></span>
<span class="w">                </span><span class="n">f</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Difference Found: {header1} -&gt; {header2}\n&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="ow">except</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">pass</span><span class="w"></span>

<span class="n">f</span><span class="p">.</span><span class="k">close</span><span class="p">()</span><span class="w"></span>
</code></pre></div>

<p>The code above finds the largest column header list (the file may have had a new column added) and uses a <code>try/except</code> to let us get the max of that to loop over.</p>
<p>Next, we check for differences between <code>header1</code> and <code>header2</code>. If they are the same, we just write that out, if they aren't, we indicate that <code>header1</code> was transformed to <code>header2</code></p>
<p>A sample of the output when the column headers have changed is below:</p>
<div class="highlight"><pre><span></span><code><span class="o">***</span> <span class="n">WARNING</span> <span class="o">***</span> <span class="n">Differences</span> <span class="n">Found</span>

<span class="n">Headers</span> <span class="n">are</span> <span class="n">the</span> <span class="n">same</span><span class="o">:</span> <span class="n">beneficiary</span> <span class="kr">first</span> <span class="n">name</span>
<span class="p">...</span>
<span class="n">Difference</span> <span class="n">Found</span><span class="o">:</span> <span class="n">person</span> <span class="n">who</span> <span class="n">made</span> <span class="n">the</span> <span class="n">request</span> <span class="o">-&gt;</span> <span class="n">who</span> <span class="n">made</span> <span class="n">the</span> <span class="n">request</span><span class="o">?</span>
<span class="p">...</span>
</code></pre></div>

<h2>Future Enhancements</h2>
<p>In just using it a couple of times I've already spotted a couple of spots for enhancements:</p>
<ol>
<li>Use <code>input</code> to allow the user to enter the names/locations of the files</li>
<li>Read the tab names and allow user to select from command line  </li>
</ol>
<h2>Conclusion</h2>
<p>I'm looking forward to implementing the enhancements mentioned above to make this even more user friendly. In the mean time, it'll get the job done and allow someone on my team to work on something more interesting then comparing excel files to try (and hopefully find) differences.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://simonwillison.net">Simon Wilison</a></li>
                            <li><a href="https://www.mattlayman.com">Matt Layman</a></li>
                            <li><a href="https://pybit.es">PyBites</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/ryancheley/">Twitter</a></li>
                            <li><a href="https://github.com/ryancheley">GitHub</a></li>
                            <li><a href="https://www.linkedin.com/in/ryan-cheley/">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>