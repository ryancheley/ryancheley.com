<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>My Place on the Internet - PyBites</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">My Place on the Internet</a></h1>
                <nav><ul>
                    <li><a href="/category/apple.html">Apple</a></li>
                    <li><a href="/category/automation.html">Automation</a></li>
                    <li><a href="/category/books.html">Books</a></li>
                    <li><a href="/category/coding.html">Coding</a></li>
                    <li><a href="/category/conferences.html">Conferences</a></li>
                    <li><a href="/category/conferenes.html">Conferenes</a></li>
                    <li><a href="/category/django.html">Django</a></li>
                    <li><a href="/category/github.html">GitHub</a></li>
                    <li><a href="/category/ios.html">iOS</a></li>
                    <li><a href="/category/macos.html">macOS</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li><a href="/category/music.html">Music</a></li>
                    <li><a href="/category/musings.html">Musings</a></li>
                    <li><a href="/category/podcasts.html">Podcasts</a></li>
                    <li><a href="/category/productivity.html">Productivity</a></li>
                    <li><a href="/category/professional-development.html">Professional Development</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                    <li><a href="/category/raspberry-pi.html">Raspberry Pi</a></li>
                    <li><a href="/category/server.html">Server</a></li>
                    <li><a href="/category/sports.html">Sports</a></li>
                    <li><a href="/category/web.html">Web</a></li>
                    <li><a href="/category/writing.html">Writing</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/writing-a-raffle-script.html">Writing a Raffle Script</a></h1>
<footer class="post-info">
        <abbr class="published" title="2020-06-29T05:24:00+02:00">
                Published: Mon 29 June 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/ryan.html">ryan</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>
<p>tags: <a href="/tag/pybites.html">PyBites</a> <a href="/tag/python.html">python</a> </p>
</footer><!-- /.post-info --><p>Due to the COVID Pandemic, many things are ... different. One thing that needed to be different this year was the way that students at my daughters middle school got to spend their ‚ÄòHero Points‚Äô.</p>
<p>Hero Points are points earned for good behavior. In a typical year the students would get to spend them at the student store, but with all of the closures, this wasn‚Äôt possible. For the students in my daughter‚Äôs 8th grade this was a big deal as they‚Äôre going on to High School next year, so we can just roll them over to next year!</p>
<p>Instead of having the kids ‚Äòspend‚Äô their Hero Points the PTO offered up the solution of a raffle based on the number of Hero Points they had. But they weren‚Äôt sure how to do it.</p>
<p>I jumped at the chance to write something like this up (especially after all of my works on the PyBites <a href="https://codechalleng.es" title="CodeChalleng.es">CodeChalleng.es</a> platform) and so my wife volunteered me üòÅ</p>
<p>In order to really get my head wrapped around the problem, I wanted to treat my solution like a real world analog. For example, in a real work raffle, when you get your tickets, there are two tickets with the same number. One that you get to hold onto, and one that goes into a bowl (or other vessel) that is randomly drawn from.</p>
<p>How many tickets?</p>
<p>Each student had some number of Hero Points. The PTO decided that 10 Hero Points would equal 1 Raffle ticket. Further, it was decided that we would ALWAYS round up. This means that 1 Hero Point would equal 1 Raffle Ticket, but that 9 Hero Points would also equal 1 Raffle Ticket.</p>
<h2>Create tickets</h2>
<p>I decided to use a <code>namedtuple</code> to store the Raffle Tickets. Specifically, I store the student name, ticket numbers they drew, and the number of tickets they have</p>
<div class="highlight"><pre><span></span><code>Raffle_Tickets = namedtuple(&#39;Raffle_Tickets&#39;, [&#39;name&#39;, &#39;ticket_numbers&#39;, &#39;tickets&#39;])
</code></pre></div>

<p>The list of student names and total Hero Points was stored in an Excel File (.xlsx) so I decided to use the Pandas Package to import it and manipulate it into a dataframe. The structure of the excel file is: Student Name, Grade, Available Points.</p>
<div class="highlight"><pre><span></span><code>df = pd.read_excel (r&#39;/Users/ryan/Documents/python-files/8th  Hero Points.xlsx&#39;)
</code></pre></div>

<p>After a bit of review it turned out that there were a couple of students with NEGATIVE Hero Points. I‚Äôm not really sure how that happened, but I was not properly accounting for that originally, so I had to update my dataframe.</p>
<p>The code below filters the dataframe to only return students with positive ‚ÄòAvailable Points‚Äô and then reindex. Finally, it calculates the number of Raffle tickets by dividing by 10 and rounding up using Python‚Äôs <code>ceil</code> function. It puts all of this into a list called <code>tickets</code>. We append our <code>tickets</code> list to the original dataframe.</p>
<div class="highlight"><pre><span></span><code><span class="nv">df</span> <span class="o">=</span> <span class="nv">df</span>[<span class="nv">df</span>[<span class="s1">&#39;</span><span class="s">Available Points</span><span class="s1">&#39;</span>] <span class="o">&gt;</span><span class="mi">0</span>]
<span class="nv">df</span>.<span class="nv">reset_index</span><span class="ss">(</span><span class="nv">inplace</span><span class="o">=</span><span class="nv">True</span>, <span class="nv">drop</span><span class="o">=</span><span class="nv">True</span><span class="ss">)</span>
<span class="nv">tickets</span> <span class="o">=</span> []
<span class="k">for</span> <span class="nv">i</span> <span class="nv">in</span> <span class="nv">df</span>[<span class="s1">&#39;</span><span class="s">Available Points</span><span class="s1">&#39;</span>] <span class="o">/</span> <span class="mi">10</span>:
    <span class="nv">tickets</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">ceil</span><span class="ss">(</span><span class="nv">i</span><span class="ss">))</span>
<span class="nv">df</span>[<span class="s1">&#39;</span><span class="s">Tickets</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">tickets</span>
</code></pre></div>

<p>Our dataframe now looks like this: Student Name, Grade, Available Points, Tickets.</p>
<p>Next, we need to figure out the Raffle ticket numbers. To do that I count the total number of Tickets available. I‚Äôm also using some extra features of the range function which allows me to set the start number of the Raffle.^<a class="footnote" href="#fn1" id="ffn1">1</a>^</p>
<div class="highlight"><pre><span></span><code><span class="nv">total_number_of_tickets</span> <span class="o">=</span> <span class="nv">sum</span><span class="ss">(</span><span class="nv">df</span>[<span class="s1">&#39;</span><span class="s">Tickets</span><span class="s1">&#39;</span>]<span class="ss">)</span>
<span class="nv">ticket_number_start</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="nv">ticket_number_list</span> <span class="o">=</span> []
<span class="k">for</span> <span class="nv">i</span> <span class="nv">in</span> <span class="nv">range</span><span class="ss">(</span><span class="nv">ticket_number_start</span>, <span class="nv">ticket_number_start</span><span class="o">+</span><span class="nv">total_number_of_tickets</span><span class="ss">)</span>:
    <span class="nv">ticket_number_list</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">i</span><span class="ss">)</span>
</code></pre></div>

<p>Once we have the list of ticket numbers I want to make a copy of it ‚Ä¶ remember there are two tickets, one that goes in the bowl and one that the student ‚Äògets‚Äô. Extending the metaphor of having two different, but related, tickets, I decided to use the <code>deepcopy</code> function on the <code>ticket_number_list</code> to create a list called <code>assigned_ticket_number_list</code>.</p>
<p>For more on deepcopy versus (shallow) copy <a href="https://docs.python.org/3/library/copy.html" title="Deepcopy">see the documentation</a></p>
<div class="highlight"><pre><span></span><code><span class="n">assigned_ticket_number_list</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">ticket_number_list</span><span class="p">)</span>
</code></pre></div>

<p>Finally, I reindex the dataframe just to add a bit more randomness to the list</p>
<div class="highlight"><pre><span></span><code><span class="nv">df</span> <span class="o">=</span> <span class="nv">df</span>.<span class="nv">reindex</span><span class="ss">(</span><span class="nv">np</span>.<span class="k">random</span>.<span class="nv">permutation</span><span class="ss">(</span><span class="nv">df</span>.<span class="nv">index</span><span class="ss">))</span>
</code></pre></div>

<h2>Assign Tickets</h2>
<p>Next we‚Äôll assign the tickets randomly to the students.</p>
<div class="highlight"><pre><span></span><code><span class="n">raffle_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="n">student_ticket_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="o">[</span><span class="n">student</span><span class="o">]</span><span class="p">.</span><span class="n">Tickets</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">assigned_ticket_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">assigned_ticket_number_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">student_ticket_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">assigned_ticket_number_list</span><span class="o">[</span><span class="n">assigned_ticket_number</span><span class="o">]</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">assigned_ticket_number_list</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">assigned_ticket_number</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">raffle_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Raffle_Tickets</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="o">[</span><span class="n">student</span><span class="o">]</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">student_ticket_list</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">student_ticket_list</span><span class="p">)))</span><span class="w"></span>
</code></pre></div>

<p>OK ‚Ä¶ the code above looks pretty dense, but basically all we‚Äôre doing is looping through the students to determine the number of tickets they each have. Once we have that we loop through the available ticket numbers and randomly assign it to the student. At the end we add a <code>namedtuple</code> object called <code>Raffle_Tickets</code> that we defined above to the raffle_list to store the student‚Äôs name, their ticket numbers, and the number of tickets that they received.</p>
<h2>Draw Tickets</h2>
<p>Now we want to ‚Äòdraw‚Äô the tickets from the ‚Äòbowl‚Äô. We want to select 25 winners, but we also don‚Äôt want to have any student win more than once. Honestly, the ‚Äô25 winning tickets with 25 distinct winners‚Äô was the hardest part to get through.</p>
<div class="highlight"><pre><span></span><code><span class="n">selected_tickets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="n">selected_ticket_number_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">ticket_number_list</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">selected_ticket_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ticket_number_list</span><span class="o">[</span><span class="n">selected_ticket_number_index</span><span class="o">]</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">raffle_list</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">selected_ticket_number</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="nl">ticket_numbers</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">ticket_number_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">x for x in ticket_number_list if x not in r.ticket_numbers</span><span class="o">]</span><span class="w"></span>
<span class="w">    </span><span class="n">selected_tickets</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_ticket_number</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>We see above that we‚Äôll select 25 items from the ‚Äòbowl‚Äô of tickets. We select the tickets one at a time. For each ticket we determine what set of tickets that selected ticket is in. Once we know that, we then remove <strong>all</strong> tickets associated with that winning ticket so that we can guarantee 25 unique winners.</p>
<h2>Find the Winners</h2>
<p>We now have 25 tickets with 25 winners. Now we just need to get their names!</p>
<div class="highlight"><pre><span></span><code><span class="nv">winners_list</span><span class="o">=</span>[]
<span class="k">for</span> <span class="nv">r</span> <span class="nv">in</span> <span class="nv">raffle_list</span>:
    <span class="k">for</span> <span class="nv">t</span> <span class="nv">in</span> <span class="nv">r</span>.<span class="nv">ticket_numbers</span>:
        <span class="nv">student_winning_list</span> <span class="o">=</span> []
        <span class="k">if</span> <span class="nv">t</span> <span class="nv">in</span> <span class="nv">selected_tickets</span>:
            <span class="nv">student_winning_list</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">t</span><span class="ss">)</span>
            <span class="nv">winners_list</span>.<span class="nv">append</span><span class="ss">((</span><span class="nv">Raffle_Tickets</span><span class="ss">(</span><span class="nv">r</span>.<span class="nv">name</span>, <span class="nv">student_winning_list</span>, <span class="nv">len</span><span class="ss">(</span><span class="nv">student_winning_list</span><span class="ss">))))</span>
</code></pre></div>

<p>Again, we construct a list of <code>namedtuple</code> <code>Raffle\_Tickets</code> only this time it‚Äôs just the winners.</p>
<h2>Output winners</h2>
<p>Whew! Now that we have the results we want to write them to a file.</p>
<div class="highlight"><pre><span></span><code><span class="nv">with</span> <span class="nv">open</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">/Users/ryan/PyBites/Raffle/winners_new.txt</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">w+</span><span class="s1">&#39;</span><span class="ss">)</span> <span class="nv">as</span> <span class="nv">f</span>:
    <span class="k">for</span> <span class="nv">winner</span> <span class="nv">in</span> <span class="nv">winners_list</span>:
        <span class="nv">tickets</span> <span class="o">=</span> <span class="nv">ticket_count</span><span class="ss">(</span><span class="nv">winner</span>.<span class="nv">name</span><span class="ss">)</span>
        <span class="nv">percent_chance_of_winning</span> <span class="o">=</span> <span class="nv">tickets</span> <span class="o">/</span> <span class="nv">total_number_of_tickets</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nv">percent_chance_of_winning_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">{:.2f}</span><span class="s2">&quot;</span>.<span class="nv">format</span><span class="ss">(</span><span class="nv">percent_chance_of_winning</span><span class="ss">)</span>
        <span class="nv">f</span>.<span class="nv">write</span><span class="ss">(</span><span class="nv">f</span><span class="s1">&#39;</span><span class="s">{winner.name} with winning ticket {winner.ticket_numbers[0]}. They had {tickets} tickets and a {percent_chance_of_winning_string}% chance of winning.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="ss">)</span>
</code></pre></div>

<p>One of the reasons that I stored the number of tickets above was so that we could see what the chance was of a student winning given the number of tickets they started with.</p>
<p>For each student we output to a line to a file with the student‚Äôs name, the winning tickets number, the number of tickets they started with and their chance of winning (the ratio of tickets the student had to the total number of starting tickets)</p>
<h2>Conclusion</h2>
<p>This was a fun project for me because it was needed for a real world application, allowed me to use MANY of the concepts I learned at PyBites <a href="https://codechalleng.es">CodeChalleng.es</a> AND helped my daughter‚Äôs school.</p>
<ol>
<li>[Why am I doing this, versus just stating a <code>0</code>? Mostly because I wanted the Raffle Ticket numbers to look like <em>real</em> Raffle Ticket Numbers. How many times have you seen a raffle ticket with number 0 on it? <a href="#ffn1">‚Ü©</a>]{#fn1}</li>
</ol>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://simonwillison.net">Simon Wilison</a></li>
                            <li><a href="https://www.mattlayman.com">Matt Layman</a></li>
                            <li><a href="https://pybit.es">PyBites</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/ryancheley/">Twitter</a></li>
                            <li><a href="https://github.com/ryancheley">GitHub</a></li>
                            <li><a href="https://www.linkedin.com/in/ryan-cheley/">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>