<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>Preparing the code for deployment to Digital Ocean</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="OK, we’ve got our server ready for our Django App. We set up Gunicorn and Nginx. We created the user which will run our app and set up all of the..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">My Place on the Internet</a></h1>
                <nav><ul>
                    <li><a href="/category/apple.html">Apple</a></li>
                    <li><a href="/category/automation.html">Automation</a></li>
                    <li><a href="/category/books.html">Books</a></li>
                    <li><a href="/category/coding.html">Coding</a></li>
                    <li><a href="/category/conferences.html">Conferences</a></li>
                    <li><a href="/category/conferenes.html">Conferenes</a></li>
                    <li class="active"><a href="/category/django.html">Django</a></li>
                    <li><a href="/category/github.html">GitHub</a></li>
                    <li><a href="/category/ios.html">iOS</a></li>
                    <li><a href="/category/macos.html">macOS</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li><a href="/category/music.html">Music</a></li>
                    <li><a href="/category/musings.html">Musings</a></li>
                    <li><a href="/category/podcasts.html">Podcasts</a></li>
                    <li><a href="/category/productivity.html">Productivity</a></li>
                    <li><a href="/category/professional-development.html">Professional Development</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                    <li><a href="/category/raspberry-pi.html">Raspberry Pi</a></li>
                    <li><a href="/category/server.html">Server</a></li>
                    <li><a href="/category/sports.html">Sports</a></li>
                    <li><a href="/category/web.html">Web</a></li>
                    <li><a href="/category/writing.html">Writing</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/preparing-the-code-for-deployment-to-digital-ocean.html" rel="bookmark"
           title="Permalink to Preparing the code for deployment to Digital Ocean">Preparing the code for deployment to Digital Ocean</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2021-02-14T12:00:00+01:00">
                Published: Sun 14 February 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/ryan.html">ryan</a>
        </address>
<p>In <a href="/category/django.html">Django</a>.</p>
<p>tags: <a href="/tag/deployment.html">Deployment</a> <a href="/tag/digital-ocean.html">digital ocean</a> <a href="/tag/series.html">series</a> </p>
</footer><!-- /.post-info -->      <p>OK, we’ve got our server ready for our Django App. We set up Gunicorn and Nginx. We created the user which will run our app and set up all of the folders that will be needed.</p>
<p>Now, we work on deploying the code!</p>
<h2>Deploying the Code</h2>
<p>There are 3 parts for deploying our code:</p>
<ol>
<li>Collect Locally</li>
<li>Copy to Server</li>
<li>Place in correct directory  </li>
</ol>
<p>Why don’t we just copy to the spot on the server we want o finally be in? Because we’ll need to restart Nginx once we’re fully deployed and it’s easier to have that done in 2 steps than in 1.</p>
<h3>Collect the Code Locally</h3>
<p>My project is structured such that there is a <code>deploy</code> folder which is on the Same Level as my Django Project Folder. That is to say</p>
<p><img alt="" class="wp-image-475" src="/images/uploads/2021/02/DraggedImage-4.png"></p>
<p>We want to clear out any old code. To do this we run from the same level that the Django Project Folder is in</p>
<div class="highlight"><pre><span></span><code>rm -rf deploy/*
</code></pre></div>

<p>This will remove ALL of the files and folders that were present. Next, we want to copy the data from the <code>yoursite</code> folder to the deploy folder:</p>
<div class="highlight"><pre><span></span><code>rsync -rv --exclude &#39;htmlcov&#39; --exclude &#39;venv&#39; --exclude &#39;*__pycache__*&#39; --exclude &#39;*staticfiles*&#39; --exclude &#39;*.pyc&#39;  yoursite/* deploy
</code></pre></div>

<p>Again, running this form the same folder. I’m using <code>rsync</code> here as it has a really good API for allowing me to exclude items (I’m sure the above could be done better with a mix of Regular Expressions, but this gets the jobs done)</p>
<h3>Copy to the Server</h3>
<p>We have the files collected, now we need to copy them to the server.</p>
<p>This is done in two steps. Again, we want to remove ALL of the files in the deploy folder on the server (see rationale from above)</p>
<div class="highlight"><pre><span></span><code>ssh root@$SERVER &quot;rm -rf /root/deploy/&quot;
</code></pre></div>

<p>Next, we use <code>scp</code> to secure copy the files to the server</p>
<div class="highlight"><pre><span></span><code>scp -r deploy root@$SERVER:/root/
</code></pre></div>

<p>Our files are now on the server!</p>
<h3>Installing the Code</h3>
<p>We have several steps to get through in order to install the code. They are:</p>
<ol>
<li>Activate the Virtual Environment</li>
<li>Deleting old files</li>
<li>Copying new files</li>
<li>Installing Python packages</li>
<li>Running Django migrations</li>
<li>Collecting static files</li>
<li>Reloading Gunicorn  </li>
</ol>
<p>Before we can do any of this we’ll need to <code>ssh</code> into our server. Once that’s done, we can proceed with the steps below.</p>
<p>Above we created our virtual environment in a folder called <code>venv</code> located in <code>/home/yoursite/</code>. We’ll want to activate it now (1)</p>
<div class="highlight"><pre><span></span><code>source /home/yoursite/venv/bin/activate
</code></pre></div>

<p>Next, we change directory into the yoursite home directory</p>
<div class="highlight"><pre><span></span><code>cd /home/yoursite/
</code></pre></div>

<p>Now, we delete the old files from the last install (2):</p>
<div class="highlight"><pre><span></span><code>rm -rf /home/yoursite/yoursite
</code></pre></div>

<p>Copy our new files (3)</p>
<div class="highlight"><pre><span></span><code>cp -r /root/deploy/ /home/yoursite/yoursite
</code></pre></div>

<p>Install our Python packages (4)</p>
<div class="highlight"><pre><span></span><code>pip install -r /home/yoursite/yoursite/requirements.txt
</code></pre></div>

<p>Run any migrations (5)</p>
<div class="highlight"><pre><span></span><code>python /home/yoursite/yoursite/manage.py migrate
</code></pre></div>

<p>Collect Static Files (6)</p>
<div class="highlight"><pre><span></span><code>python /home/yoursite/yoursite/manage.py collectstatic
</code></pre></div>

<p>Finally, reload Gunicorn</p>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">gunicorn</span>
</code></pre></div>

<p>When we visit our domain we should see our Django Site <a href="#" title="There are other steps that are neccesary like creating a superuser">fn</a></p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://simonwillison.net">Simon Wilison</a></li>
                            <li><a href="https://www.mattlayman.com">Matt Layman</a></li>
                            <li><a href="https://pybit.es">PyBites</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/ryancheley/">Twitter</a></li>
                            <li><a href="https://github.com/ryancheley">GitHub</a></li>
                            <li><a href="https://www.linkedin.com/in/ryan-cheley/">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>